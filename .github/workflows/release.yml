name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version_name:
        description: '版本號 (例如: 1.0.0-tw)'
        required: true
        default: '1.0.0-tw'

jobs:
  # ── Android APK ──────────────────────────────────────────
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: tw  # 強制切換到 tw 分支

      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.41.1"
          channel: "stable"

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  # ── Linux ────────────────────────────────────────────────
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: tw

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libayatana-appindicator3-dev

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.41.1"
          channel: "stable"

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Linux
        run: flutter build linux --release

      - name: Tar Linux build
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ${{ github.workspace }}/BaiShou-Linux.tar.gz .

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tar
          path: BaiShou-Linux.tar.gz

  # ── Windows Installer ────────────────────────────────────
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: tw

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.41.1"
          channel: "stable"

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Windows
        run: flutter build windows --release

      - name: Download Inno Setup Chinese language pack
        shell: pwsh
        run: |
          $dest = "C:\Program Files (x86)\Inno Setup 6\Languages\ChineseSimplified.isl"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/Unofficial/ChineseSimplified.isl" -OutFile $dest

      - name: Create Inno Setup script
        shell: pwsh
        run: |
          # 判斷版本號來源：手動輸入優先，其次是 Tag 名稱
          $rawVersion = "${{ github.event.inputs.version_name }}"
          if (-not $rawVersion) { $rawVersion = "${{ github.ref_name }}" }
          $version = $rawVersion.TrimStart('v')
          
          $iss = @"
          [Setup]
          AppName=白守
          AppVersion=$version
          AppPublisher=Anson-Trio
          AppPublisherURL=https://github.com/Anson-Trio/BaiShou
          DefaultDirName={autopf}\BaiShou
          DefaultGroupName=白守
          OutputDir=installer
          OutputBaseFilename=BaiShou-$rawVersion-Windows-Setup
          Compression=lzma
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64compatible
          SetupIconFile=windows\runner\resources\app_icon.ico

          [Languages]
          Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

          [Tasks]
          Name: "desktopicon"; Description: "建立桌面捷徑"; GroupDescription: "附加任務:"; Flags: unchecked

          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\白守"; Filename: "{app}\baishou.exe"
          Name: "{group}\移除白守"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\白守"; Filename: "{app}\baishou.exe"; Tasks: desktopicon

          [Run]
          Filename: "{app}\baishou.exe"; Description: "啟動白守"; Flags: nowait postinstall skipifsilent
          "@
          $iss | Out-File -FilePath setup.iss -Encoding UTF8

      - name: Build installer with Inno Setup
        shell: pwsh
        run: |
          $innoPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          & $innoPath setup.iss

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer/*.exe

  # ── GitHub Release ────────────────────────────────────────
  release:
    name: Create GitHub Release
    needs: [build-android, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts/

      - name: Download Linux tar
        uses: actions/download-artifact@v4
        with:
          name: linux-tar
          path: artifacts/

      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: artifacts/

      - name: Set Release Tag Name
        run: |
          if [ -n "${{ github.event.inputs.version_name }}" ]; then
            echo "REL_TAG=${{ github.event.inputs.version_name }}" >> $GITHUB_ENV
          else
            echo "REL_TAG=${{ github.ref_name }}" >> $GITHUB_ENV
          fi

      - name: Rename Android APK
        run: |
          mv artifacts/app-release.apk artifacts/BaiShou-${{ env.REL_TAG }}-Android.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.REL_TAG }}
          name: 白守 ${{ env.REL_TAG }}
          body: |
            ## 白守 ${{ env.REL_TAG }} (TW Branch)

            以純白誓約，守護彼此一生。

            ### 下載
            | 平台 | 文件 | 說明 |
            |------|------|------|
            | Android | `.apk` | 允許安裝未知來源後安裝 |
            | Windows | `-Setup.exe` | 雙擊執行安裝嚮導 |
            | Linux | `.tar.gz` | 解壓後執行 `baishou` |

            ### 更新內容
            請查看 [提交記錄](https://github.com/${{ github.repository }}/commits/${{ env.REL_TAG }})
          files: |
            artifacts/BaiShou-${{ env.REL_TAG }}-Android.apk
            artifacts/BaiShou-Linux.tar.gz
            artifacts/*.exe
          draft: false
          prerelease: false
